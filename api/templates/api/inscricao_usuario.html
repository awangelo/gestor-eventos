{% extends 'api/base.html' %}

{% block title %}Inscri√ß√£o de Usu√°rios{% endblock %}

{% block content %}
<section class="prototype-hero">
    <h1>Inscri√ß√£o em eventos</h1>
    {% if request.user.perfil == 'ALUNO' or request.user.perfil == 'PROFESSOR' %}
        <p>Escolha um evento dispon√≠vel e fa√ßa sua inscri√ß√£o.</p>
    {% else %}
        <p>Gerenciar inscri√ß√µes de participantes em eventos.</p>
    {% endif %}
</section>

{% if eventos %}
<section id="eventos-lista" style="margin-top: 1rem; margin-bottom: 3rem;">
    <h2 style="margin-bottom: 2rem; font-size: 1.75rem;">Eventos Dispon√≠veis</h2>
    <div class="prototype-grid">
        {% for evento in eventos %}
        <article class="prototype-card">
            {% if evento.banner %}
                <img src="{{ evento.banner.url }}" 
                     alt="Banner {{ evento.titulo|default:evento.get_tipo_display }}"
                     style="width: 100%; height: 180px; object-fit: cover; border-radius: 12px; margin-bottom: 1rem;">
            {% endif %}
            <span class="badge">{{ evento.get_tipo_display }}</span>
            <h3 style="margin: 0.5rem 0 0.75rem; font-size: 1.25rem; color: var(--text);">{{ evento.titulo|default:evento.get_tipo_display }}</h3>
            <p style="color: var(--muted); font-size: 0.925rem; line-height: 1.7; flex: 1;">
                üìÖ {{ evento.data_inicio|date:"d/m/Y" }}
                {% if evento.data_fim != evento.data_inicio %}a {{ evento.data_fim|date:"d/m/Y" }}{% endif %}<br>
                üìç {{ evento.local }}<br>
                üë• {{ evento.total_inscritos }}/{{ evento.capacidade }} inscritos ¬∑ {{ evento.vagas_disponiveis }} vagas dispon√≠veis
            </p>
            <div class="form-actions" style="margin-top: 1.25rem;">
                <a href="{% url 'detalhes-evento' evento.pk %}" class="btn primary" style="width: 100%; text-align: center;">Ver Detalhes</a>
            </div>
        </article>
        {% endfor %}
    </div>
</section>
{% endif %}

{% if participantes %}
<section class="prototype-grid">
    <article class="prototype-card" style="grid-column: 1 / -1;">
        <span class="badge">Gerenciar Inscri√ß√µes</span>
        <p>Selecione um evento e um participante para criar ou atualizar a inscri√ß√£o.</p>
        
        <form method="post">
            {% csrf_token %}
            
            {% if form_errors %}
                <div class="alert alert-error">
                    <ul>
                        {% for error in form_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
            {% if form_success %}
                <div class="alert alert-success">{{ form_success }}</div>
            {% endif %}
            
            <div class="form-group">
                <label for="inscricao-evento">Evento</label>
                <select id="inscricao-evento" name="evento" required>
                    <option value="">Selecionar evento</option>
                    {% for evento in eventos %}
                        <option value="{{ evento.pk }}" {% if form_data.evento == evento.pk|stringformat:"s" %}selected{% endif %}>
                            {{ evento.titulo|default:evento.get_tipo_display }} ¬∑ {{ evento.data_inicio|date:"d/m/Y" }} ¬∑ {{ evento.local }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="inscricao-usuario">Participante</label>
                <select id="inscricao-usuario" name="participante" required>
                    <option value="">Selecionar usu√°rio</option>
                    {% for participante in participantes %}
                        <option value="{{ participante.pk }}" {% if form_data.participante == participante.pk|stringformat:"s" %}selected{% endif %}>
                            {{ participante.nome }} ({{ participante.get_perfil_display }})
                        </option>
                    {% endfor %}
                </select>
                <small style="color: var(--muted); display: block; margin-top: 0.5rem;">
                    Ao selecionar um evento, a lista mostrar√° apenas os participantes j√° inscritos com seus status.
                </small>
            </div>
            
            <div class="form-group">
                <label for="status">Status da Inscri√ß√£o</label>
                <select id="status" name="status" required>
                    <option value="">Selecionar status</option>
                    {% for value, label in status_inscricao %}
                        <option value="{{ value }}" {% if form_data.status == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn primary">Salvar Inscri√ß√£o</button>
                <button type="reset" class="btn secondary">Limpar</button>
            </div>
        </form>
    </article>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const eventoSelect = document.getElementById('inscricao-evento');
    const participanteSelect = document.getElementById('inscricao-usuario');
    
    // Store original options with their data
    const allParticipantes = Array.from(participanteSelect.options).slice(1).map(opt => {
        return {
            value: opt.value,
            text: opt.textContent,
            selected: opt.selected
        };
    });
    
    // Event-participant mapping and status from backend
    const eventoParticipantes = {{ evento_participantes_json|safe }};
    const inscricaoStatusMap = {{ inscricao_status_map_json|safe }};
    
    eventoSelect.addEventListener('change', function() {
        const selectedEventoId = parseInt(this.value);
        
        // Clear current options except the first one
        participanteSelect.innerHTML = '<option value="">Selecionar usu√°rio</option>';
        
        if (!selectedEventoId) {
            // If no event selected, show all participants without status
            allParticipantes.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.value;
                opt.textContent = p.text;
                participanteSelect.appendChild(opt);
            });
            return;
        }
        
        // Get participants inscribed in this event
        const inscribedParticipantIds = eventoParticipantes[selectedEventoId] || [];
        
        if (inscribedParticipantIds.length === 0) {
            // No inscriptions yet - show all participants so new ones can be added
            allParticipantes.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.value;
                opt.textContent = p.text;
                participanteSelect.appendChild(opt);
            });
        } else {
            // Show inscribed participants with their status
            allParticipantes.forEach(p => {
                const participantId = parseInt(p.value);
                if (inscribedParticipantIds.includes(participantId)) {
                    const opt = document.createElement('option');
                    opt.value = p.value;
                    
                    // Get status for this participant in this event
                    const statusKey = `${selectedEventoId}_${participantId}`;
                    const status = inscricaoStatusMap[statusKey] || '';
                    
                    // Append status to the option text
                    opt.textContent = status ? `${p.text} - [${status}]` : p.text;
                    
                    participanteSelect.appendChild(opt);
                }
            });
            
            // Add separator
            const separator = document.createElement('option');
            separator.disabled = true;
            separator.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
            participanteSelect.appendChild(separator);
            
            // Add all other participants (not yet inscribed) below
            allParticipantes.forEach(p => {
                const participantId = parseInt(p.value);
                if (!inscribedParticipantIds.includes(participantId)) {
                    const opt = document.createElement('option');
                    opt.value = p.value;
                    opt.textContent = `${p.text} - [N√£o inscrito]`;
                    participanteSelect.appendChild(opt);
                }
            });
        }
    });
});
</script>
{% endif %}
{% endblock %}
