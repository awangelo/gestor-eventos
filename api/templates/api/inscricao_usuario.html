{% extends 'api/base.html' %}

{% block title %}Prot√≥tipo ¬∑ Inscri√ß√£o de Usu√°rios{% endblock %}

{% block content %}
<section class="prototype-hero">
    <h1>Inscri√ß√£o em eventos</h1>
    {% if request.user.perfil == 'ALUNO' or request.user.perfil == 'PROFESSOR' %}
        <p>Escolha um evento dispon√≠vel e fa√ßa sua inscri√ß√£o.</p>
    {% else %}
        <p>Gerenciar inscri√ß√µes de participantes em eventos.</p>
    {% endif %}
</section>

{% if eventos %}
<section id="eventos-lista" style="margin-top: 1rem; margin-bottom: 3rem;">
    <h2 style="margin-bottom: 2rem; font-size: 1.75rem;">Eventos Dispon√≠veis</h2>
    <div class="prototype-grid">
        {% for evento in eventos %}
        <article class="prototype-card">
            {% if evento.banner %}
                <img src="{{ evento.banner.url }}" 
                     alt="Banner {{ evento.titulo|default:evento.get_tipo_display }}"
                     style="width: 100%; height: 180px; object-fit: cover; border-radius: 12px; margin-bottom: 1rem;">
            {% endif %}
            <span class="badge">{{ evento.get_tipo_display }}</span>
            <h3 style="margin: 0.5rem 0 0.75rem; font-size: 1.25rem; color: var(--text);">{{ evento.titulo|default:evento.get_tipo_display }}</h3>
            <p style="color: var(--muted); font-size: 0.925rem; line-height: 1.7; flex: 1;">
                üìÖ {{ evento.data_inicio|date:"d/m/Y" }}
                {% if evento.data_fim != evento.data_inicio %}a {{ evento.data_fim|date:"d/m/Y" }}{% endif %}<br>
                üìç {{ evento.local }}<br>
                üë• {{ evento.vagas_disponiveis }} vagas dispon√≠veis
            </p>
            <div class="form-actions" style="margin-top: 1.25rem;">
                <a href="{% url 'detalhes-evento' evento.pk %}" class="btn primary" style="width: 100%; text-align: center;">Ver Detalhes</a>
            </div>
        </article>
        {% endfor %}
    </div>
</section>
{% endif %}

{% if participantes %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const eventoSelect = document.getElementById('inscricao-evento');
    const participanteSelect = document.getElementById('inscricao-usuario');
    
    // Store original options with their data
    const allParticipantes = Array.from(participanteSelect.options).slice(1).map(opt => {
        return {
            value: opt.value,
            text: opt.textContent,
            selected: opt.selected
        };
    });
    
    // Event-participant mapping and status from backend
    const eventoParticipantes = {{ evento_participantes_json|safe }};
    const inscricaoStatusMap = {{ inscricao_status_map_json|safe }};
    
    eventoSelect.addEventListener('change', function() {
        const selectedEventoId = parseInt(this.value);
        
        // Clear current options except the first one
        participanteSelect.innerHTML = '<option value="">Selecionar usu√°rio</option>';
        
        if (!selectedEventoId) {
            // If no event selected, show all participants without status
            allParticipantes.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.value;
                opt.textContent = p.text;
                participanteSelect.appendChild(opt);
            });
            return;
        }
        
        // Get participants inscribed in this event
        const inscribedParticipantIds = eventoParticipantes[selectedEventoId] || [];
        
        if (inscribedParticipantIds.length === 0) {
            // No inscriptions yet for this event
            const noOption = document.createElement('option');
            noOption.value = '';
            noOption.disabled = true;
            noOption.textContent = 'Nenhuma inscri√ß√£o neste evento ainda';
            participanteSelect.appendChild(noOption);
        } else {
            // Filter and show only inscribed participants with their status
            allParticipantes.forEach(p => {
                const participantId = parseInt(p.value);
                if (inscribedParticipantIds.includes(participantId)) {
                    const opt = document.createElement('option');
                    opt.value = p.value;
                    
                    // Get status for this participant in this event
                    const statusKey = `${selectedEventoId}_${participantId}`;
                    const status = inscricaoStatusMap[statusKey] || '';
                    
                    // Append status to the option text
                    opt.textContent = status ? `${p.text} - (${status})` : p.text;
                    
                    participanteSelect.appendChild(opt);
                }
            });
        }
    });
});
</script>
{% endif %}
{% endblock %}
